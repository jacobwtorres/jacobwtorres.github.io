<!DOCTYPE HTML>
<html>

<!-- <link rel="stylesheet" type="text/css" href="style.css"> -->

<style>
    html, body {
        height: 100%;
    }

    iframe {
        display: block;
        background: #FFF;
        border: none;
        width: 100%;
        height: 100%;
    }

    input:focus, textarea:focus, select:focus{
        outline: none;
    }

        /* chrome scrollbars */
    textarea::-webkit-scrollbar
    {
        width: 16px;
        background-color: #444;
        cursor: pointer;
    }
    textarea::-webkit-scrollbar-track
    {
        background-color: #333;
        cursor: pointer;
    }
    textarea::-webkit-scrollbar-corner
    {
      background-color: #484;
      -webkit-box-shadow: inset 0 0 6px rgba(255,255,255,0.3);
    }
    textarea::-webkit-scrollbar-thumb
    {
      background-color: #444;
      /*outline: 1px solid #666;*/
      -webkit-box-shadow: inset 0 0 6px rgba(255,255,255,0.3);
      cursor: pointer;
    }
</style>


<body onload="init()" style="overflow:hidden;" bgcolor="#333">
    <script>
		let THISURL = location.protocol + '//' + location.host + location.pathname;//'https://jacobwtorres.github.io/'
		console.log(location.protocol + '//' + location.host + location.pathname)
		let dbox_key_value = '';	
		let dbox_account_id = '';	
		let CLIENT_ID = 'p4p60gowtlk2vl9';
		// var CALLBACK_URL = 'https://'+chrome.runtime.id+'.chromiumapp.org';
		let AUTH_URL = 'https://www.dropbox.com/oauth2/authorize?client_id=' + CLIENT_ID + '&response_type=token' + '&redirect_uri=' + THISURL;
		
		let BMARK_PATH = "/Bookmarks/";
		let NOTE_PATH = "/Notes/";
		let INTERNAL_PATH = "/.internal/";
		
		let current_note_path = "";
		let already_saved = 0;
		let full_path_to_write = "";
		
		var timer;
		
		let hard_coded_login = false;
		let h_dbox_key_value = '4neAoDtRLnAAAAAAAAAs0t_ARx40cVXefKgo3B95N6H2W135ZySpOHvPJMlxNPN_';	
		let h_dbox_account_id = 'dbid:AACn7NYElGhKNkMI307nK1JxmySEsKj4y3U';
		
		var open_file = '';
		var file_list = [];
		
		var user_warned = false;
		
		function makeid(length) {
		   var result           = '';
		   var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		   var charactersLength = characters.length;
		   for ( var i = 0; i < length; i++ ) {
		      result += characters.charAt(Math.floor(Math.random() * charactersLength));
		   }
		   return result;
		}
		
		//add ability to share file with other user in realtime. Is this possible w/o dropbox?
		
		//every files cache needs metadata about whether we have already prompted the uer
		//dbox timestamp of last change when we opened it
		//already prompted to reopen with no?
		//encrypted?
		
		//different page args.
		//if arg==open with valid file name (is allowed to be path to cached file with no regular path!!!)
			//hardcode title into box and disable input
			//check for existing file lock, cache, metadata
			//if exists
				//that file is already open with unsaved changes, would you like to load them or the original?
				//if load
					//load from dbox, return
				//else
					//are you sure you would like to erase unbacked local changes?
			//else
				//it adds a remote cache of the file and grabs the timestamp
		
			//before you click save, check to see if timestampt has changed. If yes, inform the user you may be overwriting changes since someone has saved in the mean time
		//else
			//consider it a new file
			//check cache
				//if cache found and haven't hasked before about these specific changes
					//prompt user to load all available caches
				//else
					///populate button to load available caches
			//allow normal input
		
		//open button
		//popup list of files to choose from
		//if file is not .txt, check if they want to open in dropbox.com
		//ask if they want to open here or nvaigate to new tab
		//if open here
			//walk through full close procedure 
				//do you want this tab with contents to reopen?
				//if no
		//confirm: all unpushed changes are going to be wiped and this tab will not reopen
		//if confirm
			//go to open page
		
		//when you click new, allow title to be entered, and create dummy random name with remote cache and random id as open file
		//If no name entered, use prompt()
		//check for existing file
			//if name exists, confirm they want to overwrite
		//save and check success
		//save new cache under proper name, delete old cache
		//after saving, navigate to 'open' page of same file (which loads from remote and give option to load from cache) 
		
		//premium
		//enable client side encryption after 'open' functionality
		//search functionaluty in new page - also search caches
		 
		//anytime you exit, would you like this tab to reopen the next time you visit us?
		//prompt on open: We found other open files, would you like to open them now?
		//search local
		//serach remote
		
		//side bar showing ls of whole directory
		//clickable elements with options: open here, open in new tab
		
		//Load new File button instead of open
		//option to do it in a new tab or 
		
		//code for directory change being possible, but disable
		
		//add icon
		//change marcador client ID and logo
		
		//new load function that will perform option decryption if it finds appropriate header
		//in every encrypted file add comments at the top for dow to decrypt in CLI in case our service ever goes down
		//add opion to partially encrypt via ML in text??
		//prompt user password everytime
		
		//close page handler
		//ensure everything is saved to cache!!!
		//ask user if they want this to come up the next time?
		
		//add last cached timer
		
		//add logged in as 
		
		//add check user paid callbacks
		
		//add open in dropbox button
		
		//Add directory path hardcoded before file name?
		
		//create all necessary folder names!!
		
		//button to share. Sharing should be live-ish. Live-enough. But MUST not require the peer to have a dropbo acct. Must be able to get them the content they need without annoying steps
		//
		
		function clear_file_cache(file)
		{
			remove_from_list(file);
			localStorage.removeItem(file);
			localStorage.removeItem(file+".ts");
		}

		function file_list_reload()
		{
			if(localStorage.getItem("file_list") != null)
			{
				file_list = JSON.parse(localStorage.getItem("file_list"))
				console.log("Full list loaded=" + file_list)
			}
		}
		
		function add_to_list(file)
		{	
			file_list_reload();
			
			if(file_list.indexOf(file) == -1)
			{
				file_list.push(file);
				localStorage.setItem("file_list", JSON.stringify(file_list));
				console.log("Added:"+file_list); 
			}
			
		 	return file_list.indexOf(file)
		}
		
		function remove_from_list(file)
		{
			file_list_reload();
			index = file_list.indexOf(file)
			
			if(index != -1)
			{
				console.log(file + "is at index "+index)				
				file_list.splice(index, 1)
				localStorage.setItem("file_list", JSON.stringify(file_list));
			}
		}
		
		function open_all_tabs()
		{				
			for (index = 0; index < file_list.length; index++) {
				if(index == file_list.length-1)
				{
					reload_site_as(THISURL+'?open='+file_list[index])
					console.log("reload as: " + THISURL+'?open='+file_list[index])
				}
				else
				{
					open_new_site_as(THISURL+'?open='+file_list[index])
					console.log("new tab as: " + THISURL+'?open='+file_list[index])
				}
			}
		}
		
		function does_list_exist()
		{		
			console.log(file_list, file_list.length)	
			if(file_list == null || file_list.length == 0 || file_list.length == null)
			{
				return false;
			}
			else
			{
				return true;
			}
		}
		
		function open_new_file()
		{
			open_new_site_as(THISURL+"?open=.Untitled_"+makeid(9));
		}
		
		//TODO this currently warns the user that their data is about to be deleted, then STILL deletes it after they opt to preserve
	    window.onbeforeunload = function(e) {
			let lo = document.getElementById('log');
			
			save_loop("kill");
			
			if(open_file != '' && open_file != null) //this should never occur for user, but in test cases we hit it
			{
				if(ta.value != '' && ta.value != null)//normal case of accidentally opening and immediately closing new tab
				{
					
					let ch = document.getElementById('ch');
					
					ret = add_to_list(open_file);
		
					//TODO don't just checked that they are logged in, but that the file has actually saved as well
					if((ch.checked == false /*&& lo.value != "Logout"*/) || ret == -1 )
					{
						user_warned = true;
						return "HERE"
					}		
				}
				else
				{
					console.log("Clearing...")
					clear_file_cache(open_file)
				}
			}
			
	        return;
	    };
		
		//This function determines what happened in onbeforeunload, ensuring user was warned before removing file from local cache
	    window.onunload = function(e) {
			let lo = document.getElementById('log');
						
			if(open_file != '' && open_file != null) //this should never occur for user, but in test cases we hit it
			{
				if(ta.value != '' && ta.value != null)//normal case of accidentally opening and immediately closing new tab
				{
					
					let ch = document.getElementById('ch');
							
					if(ch.checked == false && lo.value != "Logout")
					{
						if(user_warned)
						{
							clear_from_cache(open_file)
						}
					}
				}
			}
	        return;
	    };
		
		function save_loop(cmd)
		{			
			
			let di = document.getElementById('di');
			let ti = document.getElementById('ti');
			let lo = document.getElementById('log');
			var timeout = 60000;
			
			user_warned = false; //just resetting this because we get no other event if the user cancels closing tab
			
			if(ta.value == "")
			{
				console.log("Skip cache. Empty");
				return;
			}			
			
			console.log("Cache now!!!");
			
			localStorage.setItem(open_file, ta.value);
			localStorage.setItem(open_file + ".ts", Date.now());
			
			if(lo.value == "Logout")
			{	
				//TODO backup to remote. WARNING callback triggered here will not fire during close event most likely. Test it.
				
				//check remote timestamp
				//if timestamp does not exist 
				
				//check for file locks as well in case another browser opened and opted to lock this one. Prompt user quickly and say editing here is now disabled.
				note_save_handler();
			}
			
			clearTimeout(timer);
			
			//because this loop reset user_warned var, it cannot rerun by accident during the close process a second time. We already run it once.
			//Timer will automatically restart on next text change
			if(cmd != "kill")
			{
				timer = setTimeout(save_loop, timeout);
			}
		}
		
		//TODO this triggers closing handlers, ensure that we are never using this in a conflicting way
		function reload_site_as(site)
		{
			window.location.href = site;
		}
		
		function open_new_site_as(url)
		{
		    var win = window.open(url, '_blank');
		    win.focus();
		}
		
		//TODO try to reauth without disturbing user
		function auth_failure_handle()
		{
		}
		
		function erase()
		{
			if(confirm("Press OK to confirm you would like to Erase this file."))
			{
				clear_file_cache(open_file)
				window.localStorage.removeItem("ta.value")
				window.localStorage.removeItem("ti.value")
				window.localStorage.removeItem("di.value")
			
				ta.value = '';
				ti.value = '';
				
				window.localStorage.removeItem("file_list")
				reload_site_as(THISURL)
			}
		}
		
		// document.onload = function()
		function init()
		{			
			
			file_list_reload();

			// add_to_list('1')
			// console.log("Full list loaded=" + file_list)
			// add_to_list('2')
			// console.log("Full list loaded=" + file_list)
			// add_to_list('3')
			// console.log("Full list loaded=" + file_list)
			//
			// remove_from_list('3')
			// console.log("Full list loaded=" + file_list)
			// remove_from_list('1')
			// console.log("Full list loaded=" + file_list)
			// remove_from_list('2')
			// console.log("Full list loaded=" + file_list)
			// return
					
			let di = document.getElementById('di');
			let ti = document.getElementById('ti');
			let lo = document.getElementById('log');
			
			let ch = document.getElementById('ch');
						
			var queryString = new URL(window.location.href.replace(/#/g,"?"));
			console.log("queryString= " + queryString);
		
			if(queryString != "")
			{
				console.log("Checking for token");
				// window.location.href = AUTH_URL;
				access_token = queryString.searchParams.get("access_token");
				console.log("Found New token: " + access_token);
				
				account_id = queryString.searchParams.get("account_id");
				console.log("Found New Account ID: " + account_id);
				
				open_file = queryString.searchParams.get("open");
				console.log("Found Open file: " + open_file);

				//THIS SECTION IS ONLY HIT DURING ACTIVE LOGIN, NOT FOR LOGGED IN STATUS
				if(access_token != null && account_id != null)
				{			
					dbox_key_value = access_token;
					dbox_account_id = account_id;
					
					localStorage.setItem("dbox_token", dbox_key_value);
					localStorage.setItem("dbox_account_id", dbox_account_id);
					
					dbox_key_check(function(ret){
						if(ret == 200)
						{
							console.log("Key worked");
							reload_site_as(THISURL);
						}
						else
						{
							console.log("Key NOT working");
							alert(	"We're sorry, but that Login to Dropbox failed. The token returned to us did not check out. To be safe we are logging you out of all accounts.");
							localStorage.removeItem("dbox_token");
							localStorage.removeItem("dbox_account_id");
							reload_site_as(THISURL);
						}
					
					})
	
					return;
				}
				else if(open_file != null)
				{
					ti.value = open_file;
					remove_from_list(open_file)
					console.log("HERE!!!!!!!!!:"+file_list)
					//TODO name check must occur here, not upon saving! Saving must be guaranteed once we start
				}
				else
				{						
					if(does_list_exist())
					{
						open_all_tabs()
					}
					else
					{
						reload_site_as(THISURL+"?open=.Untitled_"+makeid(9));
					}
				}
			}
			
			
			console.log("Token=")
			console.log(localStorage.getItem("dbox_token"))
			
			// let hard_coded_login = true;
			// let h_dbox_key_value = '';
			// let h_dbox_account_id = '';
		
			
			//load in dbx credentials
			if ((localStorage.getItem("dbox_token") == '' || localStorage.getItem("dbox_token") == null) && !hard_coded_login)
			{
				console.log("Key NOT found in storage");
				load_wo_login();
			}
			else
			{
				let lo = document.getElementById('log');
				let pu = document.getElementById('push');
				
				if(hard_coded_login == true)
				{
					console.log("Key FOUND hard coded");
					dbox_key_value = h_dbox_key_value;
					dbox_account_id = h_dbox_account_id;
				}
				else
				{
					console.log("Key FOUND in storage");
					dbox_key_value = localStorage.getItem("dbox_token");
					dbox_account_id = localStorage.getItem("dbox_account_id");	
				}
				
				dbox_key_check(function(ret){
					if(ret == 200)
					{
						console.log("Key WORKING");
						login();
					}
					else
					{
						console.log("Key NOT working");
						load_wo_login();
					}
					
				})
			}
		}
		
		function dbox_revoke_key(callback)
		{
		    var xhr = new XMLHttpRequest();
		    xhr.open('POST', 'https://api.dropboxapi.com/2/auth/token/revoke', true);
		    xhr.setRequestHeader('Authorization', 'Bearer ' + dbox_key_value);

		    xhr.onreadystatechange = function (){
				console.log("Revoke" + xhr.status)
		        if (xhr.readyState == 4)
				{
					callback(xhr.status);
		        }
		    }   
			
		    xhr.send();
		}
		
		function load_wo_login()
		{						
			let pu = document.getElementById('push');
			pu.style.visibility = 'hidden';
			pu.style.display = "none";
			
			let lo = document.getElementById('log');
			lo.value = 'Login to Dropbox';
			
			if(localStorage.getItem(open_file) != null)
			{
				console.log("Found local cache of "+open_file)
				ta.value = localStorage.getItem(open_file)
			}
		}
		
		function construct_file_path()
		{
		   	// if(di.value == "")
		   	// 		    {
				full_path_to_write = NOTE_PATH+ti.value+".txt";
		  	// }
		  	// else
		  	// {
		  	// 	full_path_to_write = NOTE_PATH+di.value+'\/'+ti.value+".txt";
		  	// }
			return full_path_to_write
		}
		
		function login()
		{
		  	let li = document.getElementById('lia');
			let un = document.getElementById('un');
			let pu = document.getElementById('push');
			let lo = document.getElementById('log');
			
			li.style.display = "inline";
			li.style.visibility = 'visible';
			
			un.style.display = "inline";
			un.style.visibility = 'visible';
		    
			console.log("Key worked");
			
			pu.style.display = "inline";
			pu.style.visibility = 'visible';
			lo.value = "Logout";
			
			cache = localStorage.getItem(open_file)
			cache_time = localStorage.getItem(open_file + ".ts")
			
			dbox_cat_file(construct_file_path(), function(contents)
			{
				if(contents == null)
				{
					ta.value = cache;
				}
				else
				{
					ta.value = contents;
				}
			})
			
			//TODO why can't I create a dir...?
			// dbox_create_folder(NOTE_PATH);
			
			//TODO check if this file is open anywhere else...put a lock on it somehow each time we open. But we must have logged in alread	
			
			//TODO check where folder exists, compare timestamps, and load most relevant version
			//we will only reach this point for ?open param
			
			//LOAD FILE TO TEXT AREA
			//TODO if only exists in cache, load cache
			//if exists in both remote/local, load whichever has more recent timestamp
			//if only exists in the remote, load remote
			//if exists in neither, check if it exists in external dbox directory
			//if only exists in extern dbox, load it and mark the caches with metadata indicating when we branched from mainline (so that we can alert to overwriting saves)
			//if nothing found, just create it as a new file in remote cache and alert to any name conflicts upon saving
		}
		
		// depends on the folder already having been ls'd into not_file_ls element. We check to see if files exists before performing the cat
		function dbox_cat_file(path, callback)
		{
		    var xhr = new XMLHttpRequest();
		    xhr.open('POST', 'https://content.dropboxapi.com/2/files/download', true);
		    xhr.setRequestHeader('Authorization', 'Bearer ' + dbox_key_value);
		    xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({"path":path}));

		    xhr.onreadystatechange = function ()
			{
		        if (xhr.readyState == 4)
				{
					if(xhr.status == 200)
					{
						callback(xhr.status);
					}
					else
					{
						callback(null);
						
					}
		        }
		    }

		    xhr.send();
		}
		
		function dbox_key_check(callback)
		{	
			url = 'https://api.dropboxapi.com/2/users/get_account'
			data = { account_id: dbox_account_id };
			fetch(url, {
				    method: 'POST', // *GET, POST, PUT, DELETE, etc.
				    mode: 'cors', // no-cors, *cors, same-origin
				    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
				    credentials: 'same-origin', // include, *same-origin, omit
				    headers: {
				      'Content-Type': 'application/json',
					  'Authorization': 'Bearer ' + dbox_key_value
				      // 'Content-Type': 'application/x-www-form-urlencoded',
				    },
				    redirect: 'follow', // manual, *follow, error
				    referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
				    body: JSON.stringify(data) // body data type must match "Content-Type" header
				  }).then(response => 
				      response.json().then(data => ({
				          data: data,
				          status: response.status
				      })
				  ).then(res => {
					  callback(res.status)
					  let un = document.getElementById('un');
					  if(res.data.name.familiar_name)
					  {
					  	un.innerHTML = res.data.name.familiar_name;
					  }
					  else
					  {
					  	un.innerHTML = res.data.name.familiar_name;
					  }
					// console.log(res.status, res.data.name.familiar_name)
				  }));
		}

		function dbox_create_folder(path, callback)
		{
		    var xhr = new XMLHttpRequest();
		    xhr.open('POST', 'https://api.dropboxapi.com/2/files/create_folder_v2', true);
		    xhr.setRequestHeader('Authorization', 'Bearer ' + dbox_key_value);
		    xhr.setRequestHeader('Content-type', 'application/json');

		    xhr.onreadystatechange = function (){
				console.log("Create" + xhr.status)
		        if (xhr.readyState == 4) {
					callback(xhr.status);
		        }
		    }  

		    var data = JSON.stringify({"path":path});

		    xhr.send(data);
		}

        //
        // desc: demonstrates textarea line numbers using canvas paint
        // auth: nikola bozovic <nigerija@gmail>
        //
        var TextAreaLineNumbersWithCanvas = function()
        {
        var div = document.createElement('div');
        var cssTable = 'padding:0px 0px 0px 0px!important; margin:0px 0px 0px 0px!important; font-size:1px;line-height:0px; width:100%;';
              var cssTd1 = 'border:1px #345 solid; border-right:0px; vertical-align:top; width:1px;';
              var cssTd2 = 'border:1px #345 solid; border-left:0px; vertical-align:top;';
              var cssButton = 'width:120px; height:40px; border:1px solid #333 !important; border-bottom-color: #484!important; color:#ffe; background-color:#222;';
              var cssCanvas = 'border:0px; background-color:#1c1c20; margin-top:0px; padding-top:0px;';
              var cssTextArea =  'width:100%;'
                               + 'height:500px;'
                               + 'font-size:11px;'
                               + 'font-family:monospace;'
                               + 'line-height:15px;'
                               + 'font-weight:500;'
                               + 'margin: 0px 0px 0px 0px;'
                               + 'padding: 0px 0px 0px 0px;'
                               + 'resize: none;'
                               + 'color:#ffa;'
                               + 'border:0px;'
                               + 'background-color:#222;'
                               + 'white-space:nowrap; overflow:auto;'
                               // supported only in opera 12.x
                               + 'scrollbar-arrow-color: #ee8;'
                               + 'scrollbar-base-color: #444;'
                               + 'scrollbar-track-color: #666;'
                               + 'scrollbar-face-color: #444;'
                               + 'scrollbar-3dlight-color: #444;' /* outer light */
                               + 'scrollbar-highlight-color: #666;' /* inner light */
                               + 'scrollbar-darkshadow-color: #444;' /* outer dark */
                               + 'scrollbar-shadow-color: #222;' /* inner dark */
                               ;

              // LAYOUT (table 2 panels)
              var table = document.createElement('table');
                  table.setAttribute('cellspacing','0');
                  table.setAttribute('cellpadding','0');
                  table.setAttribute('style', cssTable);
              var tr = document.createElement('tr');
              var td1 = document.createElement('td');
                  td1.setAttribute('style', cssTd1);
              var td2 = document.createElement('td');
                  td2.setAttribute('style', cssTd2);
                  tr.appendChild(td1);
                  tr.appendChild(td2);
                  table.appendChild(tr);

              // TEXTAREA
              var ta = this.evalnode = document.createElement('textarea');
                  ta.setAttribute('cols','80');
                  ta.setAttribute('style', cssTextArea);
                  //ta.value = this.S.get('eval') || '';  // get previous executed value ;)

              // TEXTAREA NUMBERS (Canvas)
              var canvas = document.createElement('canvas');
                  canvas.width = 48;    // must not set width & height in css !!!
                  canvas.height = 500;  // must not set width & height in css !!!
                  canvas.setAttribute('style', cssCanvas);
                  ta.canvasLines = canvas;
                  td1.appendChild(canvas);
                  td2.appendChild(ta);
                  div.appendChild(table);

              // PAINT LINE NUMBERS
              ta.paintLineNumbers = function()
              {
                try
                {
                var canvas = this.canvasLines;
                if (canvas.height != this.clientHeight) canvas.height = this.clientHeight; // on resize
                var ctx = canvas.getContext("2d");
                ctx.fillStyle = "#303030";
                ctx.fillRect(0, 0, 42, this.scrollHeight+1);
                ctx.fillStyle = "#808080";
                ctx.font = "11px monospace"; // NOTICE: must match TextArea font-size(11px) and lineheight(15) !!!
                var startIndex = Math.floor(this.scrollTop / 15,0);
                var endIndex = startIndex + Math.ceil(this.clientHeight / 15,0);
                for (var i = startIndex; i < endIndex; i++)
                {
                  var ph = 10 - this.scrollTop + (i*15);
                  var text = ''+(1+i);  // line number
                  ctx.fillText(text,40-(text.length*6),ph);
                }
                }
                catch(e){ alert(e); }
              };
              ta.onscroll     = function(ev){ this.paintLineNumbers(); };
              ta.onmousedown  = function(ev){ this.mouseisdown = true; }
              ta.onmouseup    = function(ev){ this.mouseisdown=false; this.paintLineNumbers(); };
              ta.onmousemove  = function(ev){ if (this.mouseisdown) this.paintLineNumbers(); };

              ta.onchange  = function(ev){console.log("change"); save_loop();};
              ta.onkeypress  = function(ev){console.log("keypress");};

            document.body.appendChild(div);
            // make sure it's painted
            ta.paintLineNumbers();
            return ta;
        };
		
		//TODO add mute arg since we are going to be updating so often. Or let the user choose
		function dbox_create_file(path, bin, overwrite, callback)
		{
	
		    var xhr = new XMLHttpRequest();
		    xhr.open('POST', 'https://content.dropboxapi.com/2/files/upload', true);
		    xhr.setRequestHeader('Authorization', 'Bearer ' + dbox_key_value);
		    xhr.setRequestHeader('Content-type', 'application/octet-stream');
	
			if(overwrite)
			{
			    xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({"path":path, "autorename":false,"mode":{".tag":"overwrite"}, "mute":false})); 
			}
			else
			{
			    xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({"path":path, "autorename":true,"mode":{".tag":"add"}, "mute":false})); 
			}

		    xhr.onreadystatechange = function (){
				console.log("Upload" + xhr.status)
		        if (xhr.readyState == 4) {
					callback(xhr.status);
		        }
		    }  
			
		    xhr.send(bin);
		}

		function note_save_handler()
		{
			let di = document.getElementById('di');
			let ti = document.getElementById('ti');
			let error_output = document.getElementById('error_op');
			
			console.log(di.value);
			console.log(ti.value);
			console.log(ta.value);
						
		    if(ta.value == "")
		    {
				ta.placeholder = "Enter some text here before saving!";
			  	return;
		    }
	
		    if(ti.value == "")
		    {
				error_output.style.color = 'red';
			  	error_output.innerHTML = "Please specify a file name";
				
				ti.value = prompt("Please enter a file name", "");
				if (ti.value == "")
				{
			  		return;
				}
				  
				// $("#error_op").fadeIn();
			  	return;
		    }
  
		    // if( di.value != "")
		    // {
		    // 		  	  if(di.value.includes('\\') || di.value.includes('\/'))
		    // 		  	  {
		    // 		  		  error_output.style.color = 'red';
		    // 		  	  	  error_output.innerHTML = "Folder path cannot contain slashes";
		    // 				  // $("#error_op").fadeIn();
		    // 		  	  	  return;
		    // 		  	  }
		    // 		  	  else
		    // 		  	  {
		    // 		  	  	  error_output.innerHTML = "";
		    // 				  // $("#error_op").fadeOut();
		    // 		  	  }
		    //
		    // 		  	  dbox_create_folder(NOTE_PATH + di.value);
		    //
		    // }
  
		    ti.value = ti.value.replace(/–/g, '-');
		    di.value = di.value.replace(/–/g, '-');
  
		    if(ti.value.includes('\\') || ti.value.includes('\/'))
		    {
				error_output.style.color = 'red';
		    	error_output.innerHTML = "Please remove slashes from the name";
				// $("#error_op").fadeIn();
				return;
		    }
		    else
		    {
		    	  error_output.innerHTML = "";
				  // $("#error_op").fadeOut();
		    }	
	

			dbox_create_file(construct_file_path(), ta.value, /*overwrite*/1, function(ret){
				if(ret == 200)
				{
					alert("Success");
				}
				else
				{
					alert("Failed. Data not backed up.");
					auth_failure_handle()
				}
			});
		}
		
		function logout()
		{
			let lo = document.getElementById('log');
			let pu = document.getElementById('push');
			
			dbox_revoke_key(function(ret){
				if(ret == 200)
				{
					alert("Dropbox keys successfully revoked");
				}

				reload_site_as(THISURL)
			});
			
			localStorage.removeItem("dbox_token");
			dbox_key_value = '';
			pu.style.display = "none";
			lo.value = "Login to Dropbox";
		}
		
		function log()
		{
			let lo = document.getElementById('log');
			console.log(lo.value)
			
			save_loop();
			
			if(lo.value == "Login to Dropbox")
			{
				reload_site_as(AUTH_URL)
			}
			else
			{
				logout();
			}
		}
		
		function inject_timestamp()
		{
			// let ta = document.getElementById('ta');
			if(ta.value)
			{
				ta.value = ta.value + '\n' +'[' + Date.now() + ']'
			}
			else
			{
				ta.value = '[' + Date.now() + ']'
			}
		}
		
		function mv()
		{
			var temp_name, old_name = open_file;
			let ti = document.getElementById('ti');
			let lo = document.getElementById('log');
			
			temp_name = prompt("Enter new name");
			
			if(temp_name == null)
			{
				return;
			}
			
			while(temp_name == '')
			{
				temp_name = prompt("Enter new name (type something!)");
				
				if(temp_name == null)
				{
					return;
				}
			}
							
		    temp_name = temp_name.replace(/–/g, '-');

		    if(temp_name.includes('\\') || temp_name.includes('\/'))
		    {
				temp_name = prompt("Please remove slashes from name", temp_name);
		    }
				
			ti.value = temp_name
			open_file = temp_name
			save_loop();
			clear_file_cache(old_name)
			
			if(lo.value != "Login")
			{
				//TODO kick off rename with dropbox		
			}
			
			reload_site_as(THISURL+"?open="+open_file);
		}
		
		var ta = TextAreaLineNumbersWithCanvas();
	</script>
		
	<!-- <inline> -->
    <!-- <button onclick="pull()">Pull Before</button>
	<button onclick="pull()">Pull After</button> -->
	<input id="push" type="button" onclick="note_save_handler()" value="Push">
	<input id="ts" type="button" onclick="inject_timestamp()" value="Timestamp">
	
	<input id="new" type="button" onclick="open_new_file()" value="New File">
	
	<br>
	<input id="mv" type="button" onclick="mv()" value="Rename">
	<input type="text" class="form-control"  id="ti" list="user_folders" placeholder="Untitled" value="" disabled>
	
	<input type="text" class="form-control"  id="di" list="user_folders" placeholder="Folder (optional)" value="" style="display:none;">
	<br>
	<input id="log" type="button" onclick="log()" value="Login to Dropbox">
	<span id="lia" style="display:none;">Logged in as: </span><span id="un" style="color:white;"></span>
	
	<br>
	<input id="ch" type="checkbox" name="ch" checked>
	<label for="ch"> Reopen after closing</label>
	
	<br>
	<input id="ch" type="checkbox" name="ch">
	<label for="ch"> Alert Dropbox of changes</label>
	
	<br><br>
	<label for="erase"> Debug tools:</label>
	<br>
	<input id="erase" type="button" onclick="erase()" value="Start Clean">
	<input id="refresh" type="button" onclick="reload_site_as(THISURL)" value="Reload">
	
	<!-- <div id="error_op" style="display:none;"></div> -->
	<div id="error_op"></div>
	<!-- </inline> -->
</body>

</html>
